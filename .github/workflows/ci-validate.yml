name: PowerShell Module Validation

on:
  workflow_call:
    inputs:
      module-name:
        description: 'Name of the PowerShell module to validate.'
        required: true
        type: string
      module-path:
        description: 'Relative path to the module directory (contains the manifest and module files).'
        required: true
        type: string
      module-manifest:
        description: 'Optional explicit path to the module manifest (.psd1). Defaults to <module-path>/<module-name>.psd1 when omitted.'
        required: false
        type: string
      script-analyzer-severity:
        description: 'Comma-separated list of severities to include when running PSScriptAnalyzer.'
        required: false
        type: string
        default: 'Information,Warning,Error'
      install-modules:
        description: 'Optional newline-separated list of additional modules to install before validation.'
        required: false
        type: string
      smoke-test-script-path:
        description: 'Optional path (relative to the repository root) to a PowerShell script that performs additional smoke tests.'
        required: false
        type: string

jobs:
  validate:
    name: Validate PowerShell Module
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      MODULE_NAME: ${{ inputs.module-name }}
      MODULE_PATH: ${{ inputs.module-path }}
      MODULE_MANIFEST: ${{ inputs.module-manifest != '' && inputs.module-manifest || format('{0}/{1}.psd1', inputs.module-path, inputs.module-name) }}
      ANALYZER_SEVERITY: ${{ inputs.script-analyzer-severity }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Validation Dependencies
        shell: pwsh
        env:
          INSTALL_MODULES: ${{ inputs.install-modules }}
        run: |
          $ErrorActionPreference = 'Stop'
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction SilentlyContinue
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -AllowClobber

          if ($env:INSTALL_MODULES) {
            $modules = $env:INSTALL_MODULES -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ }
            foreach ($moduleName in $modules) {
              Write-Host "Installing requested module: $moduleName" -ForegroundColor Cyan
              Install-Module -Name $moduleName -Force -Scope CurrentUser -AllowClobber
            }
          }

      - name: Run PSScriptAnalyzer
        shell: pwsh
        env:
          MODULE_PATH: ${{ env.MODULE_PATH }}
          ANALYZER_SEVERITY: ${{ env.ANALYZER_SEVERITY }}
        run: |
          Write-Host 'Running PSScriptAnalyzer...' -ForegroundColor Green
          $severityLevels = $env:ANALYZER_SEVERITY -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
          if (-not $severityLevels) {
            $severityLevels = 'Information','Warning','Error'
          }

          # Wrap in try/catch to handle known PSScriptAnalyzer NullReferenceException
          # on certain .NET runtime versions (e.g. Windows Server 2025 runners).
          try {
            $results = Invoke-ScriptAnalyzer -Path $env:MODULE_PATH -Recurse -Severity $severityLevels
          }
          catch {
            Write-Host "⚠️ PSScriptAnalyzer threw an internal error: $_" -ForegroundColor Yellow
            Write-Host 'Retrying analysis on individual files...' -ForegroundColor Yellow
            $results = @()
            $files = Get-ChildItem -Path $env:MODULE_PATH -Recurse -Include '*.ps1','*.psm1','*.psd1'
            foreach ($file in $files) {
              try {
                $fileResults = Invoke-ScriptAnalyzer -Path $file.FullName -Severity $severityLevels -ErrorAction SilentlyContinue
                if ($fileResults) { $results += $fileResults }
              }
              catch {
                Write-Host "  ⚠️ Could not analyze $($file.Name): $_" -ForegroundColor Yellow
              }
            }
          }

          if ($results) {
            Write-Host 'PSScriptAnalyzer findings:' -ForegroundColor Yellow
            $errors = $results | Where-Object Severity -eq 'Error'
            $warnings = $results | Where-Object Severity -eq 'Warning'
            $information = $results | Where-Object Severity -eq 'Information'

            if ($errors) {
              Write-Host "`n❌ ERRORS ($($errors.Count)):" -ForegroundColor Red
              $errors | Format-Table ScriptName, Line, Column, RuleName, Message -Wrap
            }

            if ($warnings) {
              Write-Host "`n⚠️ WARNINGS ($($warnings.Count)):" -ForegroundColor Yellow
              $warnings | Format-Table ScriptName, Line, Column, RuleName, Message -Wrap
            }

            if ($information) {
              Write-Host "`nℹ️ INFORMATION ($($information.Count)):" -ForegroundColor Cyan
              $information | Format-Table ScriptName, Line, Column, RuleName, Message -Wrap
            }

            Write-Host "`nSummary: $($errors.Count) error(s), $($warnings.Count) warning(s), $($information.Count) informational" -ForegroundColor White

            if ($errors.Count -gt 0) {
              throw "PSScriptAnalyzer discovered $($errors.Count) error(s)."
            }
          }
          else {
            Write-Host '✅ No PSScriptAnalyzer issues detected.' -ForegroundColor Green
          }

      - name: Resolve RequiredModules
        uses: ntatschner/tcs-shared-workflows/.github/actions/resolve-required-modules@main
        with:
          module-manifest: ${{ env.MODULE_MANIFEST }}

      - name: Import Module and Inspect Exports
        shell: pwsh
        env:
          MODULE_MANIFEST: ${{ env.MODULE_MANIFEST }}
          MODULE_NAME: ${{ env.MODULE_NAME }}
        run: |
          Write-Host 'Testing module import and exported functions...' -ForegroundColor Green

          try {
            $resolvedManifestPath = Resolve-Path -Path $env:MODULE_MANIFEST -ErrorAction Stop

            Import-Module -Name $resolvedManifestPath -Force -ErrorAction Stop
            Write-Host "✅ Module '$env:MODULE_NAME' imported successfully." -ForegroundColor Green

            $module = Get-Module $env:MODULE_NAME
            if (-not $module) {
              throw "Module '$env:MODULE_NAME' did not remain loaded after import."
            }

            $exportedFunctions = $module.ExportedFunctions
            if (-not $exportedFunctions -or $exportedFunctions.Count -eq 0) {
              Write-Warning '⚠️ Module does not export any functions.'
            }
            else {
              Write-Host "Exported functions ($($exportedFunctions.Count)):" -ForegroundColor Cyan
              $exportedFunctions.Keys | Sort-Object | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }

              Write-Host "`nChecking for help documentation..." -ForegroundColor Green
              $functionsWithoutHelp = @()
              foreach ($functionName in $exportedFunctions.Keys) {
                $help = Get-Help $functionName -ErrorAction SilentlyContinue
                if (-not $help -or [string]::IsNullOrWhiteSpace($help.Synopsis)) {
                  $functionsWithoutHelp += $functionName
                }
              }

              if ($functionsWithoutHelp.Count -gt 0) {
                Write-Warning '⚠️ Functions missing help documentation:'
                $functionsWithoutHelp | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
              }
              else {
                Write-Host '✅ All exported functions have discoverable help documentation.' -ForegroundColor Green
              }
            }
          }
          catch {
            Write-Error "❌ Module import or inspection failed: $_"
            throw
          }
          finally {
            Remove-Module $env:MODULE_NAME -Force -ErrorAction SilentlyContinue
          }

      - name: Execute Smoke Tests
        if: inputs.smoke-test-script-path != ''
        shell: pwsh
        env:
          SCRIPT_PATH: ${{ inputs.smoke-test-script-path }}
        run: |
          $resolvedPath = Join-Path (Get-Location) $env:SCRIPT_PATH
          if (Test-Path $resolvedPath) {
            $resolvedPath = (Resolve-Path $resolvedPath).Path
          }
          $workspace = (Get-Location).Path
          if (-not $resolvedPath.StartsWith($workspace + [IO.Path]::DirectorySeparatorChar)) {
            throw "Script path must be within the repository workspace. Resolved to: $resolvedPath"
          }
          if (-not (Test-Path $resolvedPath)) {
            throw "Smoke test script not found at path: $resolvedPath"
          }

          Write-Host "Running smoke test script at '$resolvedPath'..." -ForegroundColor Green
          try {
            & $resolvedPath
            Write-Host '✅ Smoke tests completed successfully.' -ForegroundColor Green
          }
          catch {
            Write-Error "❌ Smoke tests failed: $_"
            throw
          }

      - name: Validation Summary
        if: always()
        shell: pwsh
        env:
          JOB_STATUS: ${{ job.status }}
        run: |
          $ErrorActionPreference = 'Stop'
          $jobStatus = $env:JOB_STATUS
          Write-Host "`n=== Validation Complete ===" -ForegroundColor Cyan
          if ($jobStatus -eq 'success') {
            Write-Host '✅ All validation checks passed.' -ForegroundColor Green
            exit 0
          }
          Write-Host '❌ One or more validation checks failed. Review the log output above for details.' -ForegroundColor Red
          exit 1
