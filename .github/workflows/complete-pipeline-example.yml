name: Complete PowerShell Module Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'module/**'
      - '.github/workflows/**'
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
    paths:
      - 'module/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish to PowerShell Gallery even if version exists'
        required: false
        default: false
        type: boolean
      skip_docs_website:
        description: 'Skip publishing documentation to website'
        required: false
        default: false
        type: boolean

env:
  MODULE_NAME: 'tcs.core'
  MODULE_PATH: './module/tcs.core'
  DOCS_PATH: './docs'

jobs:
  # Step 1: Validate the PowerShell module
  validate:
    name: Validate Module
    uses: ./.github/workflows/powershell-validate.yml
    with:
      module_name: 'tcs.core'
      module_path: './module/tcs.core'
      run_function_tests: true
      test_functions: |
        [
          {
            "name": "ConvertTo-CamelCase",
            "command": "ConvertTo-CamelCase -Value 'HelloWorld'",
            "expected": "helloWorld"
          },
          {
            "name": "New-DynamicParameter",
            "command": "$result = New-DynamicParameter -Name 'TestParam' -ParameterType ([string]) -Mandatory; $result.Name",
            "expected": "TestParam"
          }
        ]

  # Step 2: Generate documentation (only on main branch or manual trigger)
  generate-docs:
    name: Generate Documentation
    needs: validate
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/powershell-docs.yml
    with:
      module_name: 'tcs.core'
      module_path: './module/tcs.core'
      docs_path: './docs'
      required_modules: '[]'
      stub_functions: '[]'
      commit_docs: true
      locale: 'en-US'

  # Step 3: Publish to PowerShell Gallery (only on tags or manual trigger)
  publish-psgallery:
    name: Publish to PowerShell Gallery
    needs: [validate, generate-docs]
    if: always() && (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch') && needs.validate.outputs.validation_result == 'success'
    uses: ./.github/workflows/powershell-publish.yml
    with:
      module_name: 'tcs.core'
      module_path: './module/tcs.core'
      force_publish: ${{ github.event.inputs.force_publish == 'true' }}
      create_github_release: true
      run_validation: false  # Already validated in previous step
    secrets:
      PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}

  # Step 4: Publish documentation to website (only if docs were generated)
  publish-docs-website:
    name: Publish Docs to Website
    needs: [validate, generate-docs]
    if: always() && needs.generate-docs.outputs.docs_generated == 'true' && github.event.inputs.skip_docs_website != 'true'
    uses: ./.github/workflows/publish-docs-website.yml
    with:
      docs_path: './docs'
      website_api_endpoint: 'https://your-website.com/api/docs/upload'
      docs_format: 'markdown'
      module_name: 'tcs.core'
      docs_version: ${{ needs.validate.outputs.module_version }}
      publish_method: 'api'
      dry_run: false
    secrets:
      WEBSITE_API_KEY: ${{ secrets.WEBSITE_API_KEY }}
      WEBSITE_AUTH_TOKEN: ${{ secrets.WEBSITE_AUTH_TOKEN }}

  # Final summary
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [validate, generate-docs, publish-psgallery, publish-docs-website]
    if: always()
    
    steps:
    - name: Pipeline Results
      shell: bash
      run: |
        echo "=== PowerShell Module Pipeline Results ==="
        echo ""
        echo "üîç Validation: ${{ needs.validate.result }}"
        echo "üìñ Documentation: ${{ needs.generate-docs.result }}"
        echo "üì¶ PowerShell Gallery: ${{ needs.publish-psgallery.result }}"
        echo "üåê Website Docs: ${{ needs.publish-docs-website.result }}"
        echo ""
        
        if [ "${{ needs.validate.result }}" = "success" ]; then
          echo "‚úÖ Module validation passed"
          echo "   Version: ${{ needs.validate.outputs.module_version }}"
        else
          echo "‚ùå Module validation failed"
        fi
        
        if [ "${{ needs.generate-docs.result }}" = "success" ]; then
          echo "‚úÖ Documentation generated successfully"
        elif [ "${{ needs.generate-docs.result }}" = "skipped" ]; then
          echo "‚è≠Ô∏è Documentation generation skipped"
        else
          echo "‚ùå Documentation generation failed"
        fi
        
        if [ "${{ needs.publish-psgallery.result }}" = "success" ]; then
          echo "‚úÖ Published to PowerShell Gallery"
        elif [ "${{ needs.publish-psgallery.result }}" = "skipped" ]; then
          echo "‚è≠Ô∏è PowerShell Gallery publishing skipped"
        else
          echo "‚ùå PowerShell Gallery publishing failed"
        fi
        
        if [ "${{ needs.publish-docs-website.result }}" = "success" ]; then
          echo "‚úÖ Documentation published to website"
          if [ -n "${{ needs.publish-docs-website.outputs.docs_url }}" ]; then
            echo "   URL: ${{ needs.publish-docs-website.outputs.docs_url }}"
          fi
        elif [ "${{ needs.publish-docs-website.result }}" = "skipped" ]; then
          echo "‚è≠Ô∏è Website documentation publishing skipped"
        else
          echo "‚ùå Website documentation publishing failed"
        fi