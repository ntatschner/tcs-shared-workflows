name: PowerShell Module Validation

on:
  workflow_call:
    inputs:
      module_name:
        description: 'Name of the PowerShell module'
        required: true
        type: string
      module_path:
        description: 'Path to the PowerShell module'
        required: true
        type: string
      run_function_tests:
        description: 'Whether to run basic function tests'
        required: false
        type: boolean
        default: true
      test_functions:
        description: 'JSON array of functions to test with their expected behavior'
        required: false
        type: string
        default: '[]'
    outputs:
      validation_result:
        description: 'Result of the validation (success/failure)'
        value: ${{ jobs.validate.outputs.result }}
      module_version:
        description: 'Version of the validated module'
        value: ${{ jobs.validate.outputs.version }}

jobs:
  validate:
    name: Validate PowerShell Module
    runs-on: windows-latest
    outputs:
      result: ${{ steps.summary.outputs.result }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup PowerShell Environment
      shell: pwsh
      run: |
        Write-Host "Setting up PowerShell environment..." -ForegroundColor Green
        Install-Module -Name PowerShellGet -Force -AllowClobber -Scope CurrentUser
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

    - name: Test Module Manifest
      shell: pwsh
      run: |
        Write-Host "Testing module manifest..." -ForegroundColor Green
        $manifestPath = "${{ inputs.module_path }}/${{ inputs.module_name }}.psd1"
        
        if (-not (Test-Path $manifestPath)) {
          throw "Module manifest not found at: $manifestPath"
        }
        
        try {
          $manifest = Test-ModuleManifest -Path $manifestPath -ErrorAction Stop
          Write-Host "✅ Module manifest is valid" -ForegroundColor Green
          Write-Host "Module: $($manifest.Name)" -ForegroundColor Cyan
          Write-Host "Version: $($manifest.Version)" -ForegroundColor Cyan
          Write-Host "Author: $($manifest.Author)" -ForegroundColor Cyan
          Write-Host "Description: $($manifest.Description)" -ForegroundColor Cyan
          
          # Check required fields for PowerShell Gallery
          $checks = @{
            'Version' = $manifest.Version
            'Description' = $manifest.Description  
            'Author' = $manifest.Author
          }
          
          foreach ($check in $checks.GetEnumerator()) {
            if (-not $check.Value -or [string]::IsNullOrWhiteSpace($check.Value)) {
              throw "Required field '$($check.Key)' is missing or empty"
            }
          }
          Write-Host "✅ All required fields are present" -ForegroundColor Green
        }
        catch {
          Write-Error "❌ Module manifest validation failed: $_"
          throw
        }

    - name: Get Module Version
      id: get_version
      shell: pwsh
      run: |
        $manifestPath = "${{ inputs.module_path }}/${{ inputs.module_name }}.psd1"
        $manifest = Import-PowerShellDataFile -Path $manifestPath
        $version = $manifest.ModuleVersion
        Write-Host "Module version: $version" -ForegroundColor Green
        echo "version=$version" >> $env:GITHUB_OUTPUT

    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        Write-Host "Running PSScriptAnalyzer..." -ForegroundColor Green
        $results = Invoke-ScriptAnalyzer -Path "${{ inputs.module_path }}" -Recurse -Severity Information,Warning,Error
        
        if ($results) {
          Write-Host "PSScriptAnalyzer Results:" -ForegroundColor Yellow
          
          # Group results by severity
          $errors = $results | Where-Object Severity -eq 'Error'
          $warnings = $results | Where-Object Severity -eq 'Warning'  
          $info = $results | Where-Object Severity -eq 'Information'
          
          if ($errors) {
            Write-Host "`n❌ ERRORS ($($errors.Count)):" -ForegroundColor Red
            $errors | Format-Table ScriptName, Line, Column, RuleName, Message -Wrap
          }
          
          if ($warnings) {
            Write-Host "`n⚠️ WARNINGS ($($warnings.Count)):" -ForegroundColor Yellow
            $warnings | Format-Table ScriptName, Line, Column, RuleName, Message -Wrap
          }
          
          if ($info) {
            Write-Host "`nℹ️ INFORMATION ($($info.Count)):" -ForegroundColor Cyan
            $info | Format-Table ScriptName, Line, Column, RuleName, Message -Wrap
          }
          
          # Summary
          Write-Host "`nSummary: $($errors.Count) error(s), $($warnings.Count) warning(s), $($info.Count) info" -ForegroundColor White
          
          # Fail on errors
          if ($errors.Count -gt 0) {
            throw "PSScriptAnalyzer found $($errors.Count) error(s). Please fix before merging."
          }
        } else {
          Write-Host "✅ No PSScriptAnalyzer issues found" -ForegroundColor Green
        }

    - name: Test Module Import
      shell: pwsh
      run: |
        Write-Host "Testing module import..." -ForegroundColor Green
        try {
          # Import the module
          Import-Module "${{ inputs.module_path }}/${{ inputs.module_name }}.psd1" -Force -ErrorAction Stop
          Write-Host "✅ Module imports successfully" -ForegroundColor Green
          
          # Test exported functions
          $module = Get-Module ${{ inputs.module_name }}
          $exportedFunctions = $module.ExportedFunctions
          
          if ($exportedFunctions.Count -eq 0) {
            Write-Warning "⚠️ No functions are exported by this module"
          } else {
            Write-Host "Exported functions ($($exportedFunctions.Count)):" -ForegroundColor Cyan
            $exportedFunctions.Keys | Sort-Object | ForEach-Object { 
              Write-Host "  - $_" -ForegroundColor Gray 
            }
          }
          
          # Test that help is available for exported functions
          Write-Host "`nTesting help documentation..." -ForegroundColor Green
          $functionsWithoutHelp = @()
          
          foreach ($functionName in $exportedFunctions.Keys) {
            $help = Get-Help $functionName -ErrorAction SilentlyContinue
            if (-not $help -or $help.Synopsis -like "*$functionName*" -and $help.Synopsis -notmatch '\w+\s+\w+') {
              $functionsWithoutHelp += $functionName
            }
          }
          
          if ($functionsWithoutHelp) {
            Write-Warning "⚠️ Functions without proper help documentation:"
            $functionsWithoutHelp | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
          } else {
            Write-Host "✅ All functions have help documentation" -ForegroundColor Green
          }
        }
        catch {
          Write-Error "❌ Module import failed: $_"
          throw
        }
        finally {
          # Clean up
          Remove-Module ${{ inputs.module_name }} -Force -ErrorAction SilentlyContinue
        }

    - name: Test Function Execution
      if: inputs.run_function_tests == true
      shell: pwsh
      run: |
        Write-Host "Testing basic function execution..." -ForegroundColor Green
        
        # Import the module
        Import-Module "${{ inputs.module_path }}/${{ inputs.module_name }}.psd1" -Force
        
        try {
          # Parse custom test functions if provided
          $testFunctions = '${{ inputs.test_functions }}' | ConvertFrom-Json -ErrorAction SilentlyContinue
          
          if ($testFunctions -and $testFunctions.Count -gt 0) {
            Write-Host "Running custom function tests..." -ForegroundColor Green
            foreach ($test in $testFunctions) {
              Write-Host "Testing function: $($test.name)" -ForegroundColor Cyan
              
              # Execute the test command
              $result = Invoke-Expression $test.command
              
              # Check expected result if provided
              if ($test.expected -and $result -ne $test.expected) {
                throw "Function $($test.name) returned unexpected result. Expected: $($test.expected), Got: $result"
              }
              
              Write-Host "✅ $($test.name) test passed" -ForegroundColor Green
            }
          } else {
            Write-Host "No custom function tests provided, skipping function execution tests" -ForegroundColor Yellow
          }
          
          Write-Host "✅ All function tests passed" -ForegroundColor Green
        }
        catch {
          Write-Error "❌ Function testing failed: $_"
          throw
        }
        finally {
          Remove-Module ${{ inputs.module_name }} -Force -ErrorAction SilentlyContinue
        }

    - name: Validation Summary
      id: summary
      if: always()
      shell: pwsh
      run: |
        $jobStatus = '${{ job.status }}'
        Write-Host "`n=== Validation Complete ===" -ForegroundColor Cyan
        if ($jobStatus -eq 'success') {
          Write-Host "✅ All validation checks passed!" -ForegroundColor Green
          Write-Host "The module is ready for the next steps." -ForegroundColor Green
          echo "result=success" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "❌ Some validation checks failed." -ForegroundColor Red
          Write-Host "Please review the errors above and fix them." -ForegroundColor Red
          echo "result=failure" >> $env:GITHUB_OUTPUT
        }