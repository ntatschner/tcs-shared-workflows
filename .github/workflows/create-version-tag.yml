# Creates and pushes a version tag (e.g. v0.0.3) when the module manifest version
# is greater than the current latest tag. Use on push to main after bumping ModuleVersion.
name: Create Version Tag

on:
  workflow_call:
    inputs:
      module-name:
        description: 'Name of the PowerShell module (used for logging).'
        required: true
        type: string
      module-path:
        description: 'Relative path to the module directory containing the manifest.'
        required: true
        type: string
      module-manifest:
        description: 'Optional path to the .psd1. Defaults to <module-path>/<module-name>.psd1.'
        required: false
        type: string
      tag-prefix:
        description: 'Prefix for the tag (e.g. v for v0.0.3).'
        required: false
        type: string
        default: 'v'
      ref:
        description: 'Optional ref (commit SHA, branch, or tag) to checkout. Use workflow_run.head_sha when chained after CI Validate.'
        required: false
        type: string
    secrets:
      repo-token:
        description: 'Token with contents: write (to push tags). Defaults to GITHUB_TOKEN.'
        required: false

jobs:
  create-tag:
    name: Create tag if version increased
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      MODULE_NAME: ${{ inputs.module-name }}
      MODULE_PATH: ${{ inputs.module-path }}
      MODULE_MANIFEST: ${{ inputs.module-manifest != '' && inputs.module-manifest || format('{0}/{1}.psd1', inputs.module-path, inputs.module-name) }}
      TAG_PREFIX: ${{ inputs.tag-prefix }}
      REPO_TOKEN: ${{ secrets.repo-token != '' && secrets.repo-token || secrets.GITHUB_TOKEN }}
    outputs:
      tag_created: ${{ steps.tag.outputs.tag_created }}
      new_tag: ${{ steps.tag.outputs.new_tag }}
    steps:
      - name: Checkout (fetch all tags)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0
          token: ${{ env.REPO_TOKEN }}

      - name: Get manifest version and latest tag, create tag if increased
        id: tag
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Test-Path $env:MODULE_MANIFEST)) {
            throw "Module manifest not found: $env:MODULE_MANIFEST"
          }
          $manifest = Import-PowerShellDataFile -Path $env:MODULE_MANIFEST
          $manifestVersion = $manifest.ModuleVersion
          if (-not $manifestVersion) {
            throw "ModuleVersion not found in $env:MODULE_MANIFEST"
          }
          $manifestVer = [version]$manifestVersion
          Write-Host "Manifest version: $manifestVersion" -ForegroundColor Cyan

          $prefix = $env:TAG_PREFIX.Trim()
          $tags = git tag -l "${prefix}*" --sort=-v:refname 2>$null
          $latestTag = if ($tags) { $tags | Select-Object -First 1 } else { $null }
          $latestVersion = $null
          if ($latestTag) {
            $tagOnly = $latestTag -replace "^$([regex]::Escape($prefix))", ''
            $tryVer = $null
            if ([version]::TryParse($tagOnly, [ref]$tryVer)) {
              $latestVersion = $tryVer
              Write-Host "Latest tag: $latestTag (version $tagOnly)" -ForegroundColor Cyan
            }
            else {
              Write-Host "Latest tag '$latestTag' could not be parsed as version; treating as no previous tag." -ForegroundColor Yellow
            }
          }
          if (-not $latestVersion) {
            Write-Host "No previous version tag found. Creating first tag." -ForegroundColor Yellow
          }

          if ($latestVersion -and $manifestVer -le $latestVersion) {
            Write-Host "Manifest version $manifestVersion is not greater than latest tag ($latestTag). No tag created." -ForegroundColor Yellow
            "tag_created=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "new_tag=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            exit 0
          }

          $newTag = "${prefix}${manifestVersion}"
          if (git rev-parse "refs/tags/$newTag" 2>$null) {
            Write-Host "Tag $newTag already exists. Skipping." -ForegroundColor Yellow
            "tag_created=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "new_tag=$newTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            exit 0
          }

          git tag $newTag
          git push origin $newTag
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to push tag $newTag (exit code $LASTEXITCODE). Check repo permissions."
          }
          Write-Host "Created and pushed tag: $newTag" -ForegroundColor Green
          "tag_created=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "new_tag=$newTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
